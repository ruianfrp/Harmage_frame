<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.harmonycloud.dao.ProjectProbRiskDao">

    <!--
        insert update 一定要有parameterType
        select 一定要有resultType 否则报错
        It's likely that neither a Result Type nor a Result Map was specified

        Binding Exception:
        1.namespace error 2. id=function name
        3.erase chinese character 4. add/delete some space
    -->
    <insert id="insertProjectProbRisk" parameterType="com.harmonycloud.bean.project.ProjectProbRisk">
        insert into project_prob_risk(description,solution,est_settle_time,act_settle_time,current_state,
        proposed_time,proposed_person,incharge_person,fk_project_id,type)
        values(#{description},#{solution},#{estSettleTime},#{actSettleTime},#{currentState},#{proposedTime},
        #{proposedPerson},#{inChargePerson},#{fkProjectId},#{type})
    </insert>

    <select id="listProjectProbRiskById" resultType="com.harmonycloud.bean.project.ProjectProbRisk">
        select * from project_prob_risk
        where fk_project_id = #{projectId}
    </select>

    
    <update id="updateProjectProbRisk" parameterType="com.harmonycloud.bean.project.ProjectProbRisk">
        update project_prob_risk
        <set>
            <if test="description!=null">
                description = #{description}
            </if>
            <if test="solution!=null">
                solution = #{solution}
            </if>
            <if test="estSettleTime!=null">
                est_settle_time = #{estSettleTime}
            </if>
            <if test="actSettleTime!=null">
                act_settle_time = #{actSettleTime}
            </if>
            <if test = "currentState!=null">
                current_state = #{currentState}
            </if>
            <if test="proposedTime!=null">
                proposed_time = #{proposedTime}
            </if>
            <if test="proposedPerson!=null">
                proposed_person = #{proposedPerson}
            </if>
            <if test="inChargePerson!=null">
                in_charge_person = #{inChargePerson}
            </if>
        </set>
        where id = #{id}
    </update>

    <delete id="deleteProjectProbRisk" parameterType="java.lang.Integer">
        delete from project_prob_risk
        where id = #{id}
    </delete>

    <select id="listProjectProbRiskState" resultType="com.harmonycloud.bean.project.ProjectProbRiskState">
        select fk_project_id as projectId,proj_name,count(proj_name) as probRiskCount
        from project_prob_risk left join project
        on fk_project_id = project.id
        where current_state = 0
        GROUP BY fk_project_id
    </select>

    <select id="selectProbRiskDescription" resultType="java.lang.String">
        select description
        from project_prob_risk
        where fk_project_id = #{projectId} and current_state = 0
        LIMIT 0,1
    </select>

    <!--select id="countOfProb" resultType="java.lang.Integer">
        select count(*) as count from project_prob_risk
        GROUP BY type
        having type = 0
    </select>

    <select id="countOfRisk" resultType="java.lang.Integer">
        select count(*) as count from project_prob_risk
        GROUP BY type
        having type = 1
    </select-->
</mapper>